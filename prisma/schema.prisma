generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String           @id @default(cuid())
  name           String?
  email          String           @unique
  emailVerified  DateTime?
  image          String?
  password       String?
  role           Role             @default(OPERATOR)
  isActive       Boolean          @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  customerId     String?          @unique
  accounts       Account[]
  activityLogs   ActivityLog[]
  deliveryNotes  DeliveryNote[]
  invoices       Invoice[]
  orders         Order[]
  sessions       Session[]
  stockMovements StockMovement[]  @relation("StockMovements")
  customer       Customer?        @relation(fields: [customerId], references: [id])
  preferences    UserPreferences?
}

model UserPreferences {
  id            String  @id @default(cuid())
  userId        String  @unique
  theme         Theme   @default(SYSTEM)
  language      String  @default("it")
  notifications Boolean @default(true)
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ProductCategory {
  id          String              @id @default(cuid())
  name        String              @unique
  slug        String              @unique
  type        ProductCategoryType
  description String?
  icon        String?
  sortOrder   Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  products    Product[]
}

model Product {
  id                   String                 @id @default(cuid())
  name                 String
  slug                 String                 @unique
  categoryId           String
  unit                 ProductUnit            @default(KG)
  defaultPrice         Decimal                @db.Decimal(10, 2)
  costPrice            Decimal?               @db.Decimal(10, 2)
  isAvailable          Boolean                @default(true)
  seasonalFrom         Int?
  seasonalTo           Int?
  image                String?
  description          String?
  sku                  String?                @unique
  vatRate              Decimal                @default(4) @db.Decimal(4, 2)
  minOrderQuantity     Decimal?               @db.Decimal(10, 3)
  isFeatured           Boolean                @default(false)
  featuredUntil        DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  customerPrices       CustomerProductPrice[]
  deliveryNoteItems    DeliveryNoteItem[]
  invoiceItems         InvoiceItem[]
  orderItems           OrderItem[]
  category             ProductCategory        @relation(fields: [categoryId], references: [id])
  purchaseOrderItems   PurchaseOrderItem[]
  shoppingListItems    ShoppingListItem[]
  stockMovements       StockMovement[]
  supplierInvoiceItems SupplierInvoiceItem[]
  supplierProducts     SupplierProduct[]

  @@index([categoryId])
  @@index([isAvailable])
}

model CustomerProductPrice {
  id         String   @id @default(cuid())
  customerId String
  productId  String
  price      Decimal  @db.Decimal(10, 2)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
}

model Customer {
  id                    String                 @id @default(cuid())
  code                  String                 @unique
  companyName           String
  type                  CustomerType
  vatNumber             String?
  fiscalCode            String?
  sdiCode               String?
  pecEmail              String?
  address               String
  city                  String
  province              String
  postalCode            String
  country               String                 @default("IT")
  phone                 String?
  email                 String?
  deliveryZone          String?
  preferredDeliveryTime String?
  deliveryNotes         String?
  paymentMethod         PaymentMethod          @default(BONIFICO)
  paymentTermsDays      Int                    @default(30)
  creditLimit           Decimal?               @db.Decimal(10, 2)
  isActive              Boolean                @default(true)
  notes                 String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  contacts              Contact[]              @relation("CustomerContacts")
  creditNotes           CreditNote[]
  customerPrices        CustomerProductPrice[]
  deliveryNotesDocs     DeliveryNote[]
  invoices              Invoice[]
  orders                Order[]
  payments              Payment[]              @relation("CustomerPayments")
  portalUser            User?

  @@index([type])
  @@index([city])
  @@index([isActive])
}

model Supplier {
  id                String             @id @default(cuid())
  code              String             @unique
  companyName       String
  vatNumber         String?
  fiscalCode        String?
  address           String?
  city              String?
  province          String?
  postalCode        String?
  country           String             @default("IT")
  phone             String?
  email             String?
  paymentMethod     PaymentMethod      @default(BONIFICO)
  paymentTermsDays  Int                @default(30)
  isActive          Boolean            @default(true)
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  contacts          Contact[]          @relation("SupplierContacts")
  invoiceItems      InvoiceItem[]
  payments          Payment[]          @relation("SupplierPayments")
  purchaseOrders    PurchaseOrder[]
  shoppingListItems ShoppingListItem[]
  supplierInvoices  SupplierInvoice[]
  supplierProducts  SupplierProduct[]
}

model SupplierProduct {
  id           String   @id @default(cuid())
  supplierId   String
  productId    String
  price        Decimal  @db.Decimal(10, 2)
  isPreferred  Boolean  @default(false)
  leadTimeDays Int?
  minOrderQty  Decimal? @db.Decimal(10, 3)
  notes        String?
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier     Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productId])
}

model Contact {
  id         String    @id @default(cuid())
  firstName  String
  lastName   String
  role       String?
  phone      String?
  mobile     String?
  email      String?
  isPrimary  Boolean   @default(false)
  customerId String?
  supplierId String?
  customer   Customer? @relation("CustomerContacts", fields: [customerId], references: [id], onDelete: Cascade)
  supplier   Supplier? @relation("SupplierContacts", fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([supplierId])
}

model Order {
  id                    String              @id @default(cuid())
  orderNumber           String              @unique
  customerId            String
  status                OrderStatus         @default(RECEIVED)
  channel               OrderChannel        @default(MANUAL)
  orderDate             DateTime            @default(now())
  requestedDeliveryDate DateTime?
  notes                 String?
  internalNotes         String?
  subtotal              Decimal             @default(0) @db.Decimal(10, 2)
  vatAmount             Decimal             @default(0) @db.Decimal(10, 2)
  total                 Decimal             @default(0) @db.Decimal(10, 2)
  createdById           String?
  whatsappMessageId     String?
  audioTranscriptionId  String?
  sourceEmailId         String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  deliveryNote          DeliveryNote?
  audioTranscription    AudioTranscription? @relation(fields: [audioTranscriptionId], references: [id])
  createdBy             User?               @relation(fields: [createdById], references: [id])
  customer              Customer            @relation(fields: [customerId], references: [id])
  whatsappMessage       WhatsAppMessage?    @relation(fields: [whatsappMessageId], references: [id])
  items                 OrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([orderDate])
  @@index([channel])
}

model OrderItem {
  id          String      @id @default(cuid())
  orderId     String
  productId   String?
  quantity    Decimal     @db.Decimal(10, 3)
  unit        ProductUnit
  unitPrice   Decimal     @db.Decimal(10, 2)
  vatRate     Decimal     @default(4) @db.Decimal(4, 2)
  lineTotal   Decimal     @db.Decimal(10, 2)
  notes       String?
  sortOrder   Int         @default(0)
  productName String?
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product?    @relation(fields: [productId], references: [id])

  @@index([orderId])
}

model DeliveryNote {
  id               String             @id @default(cuid())
  ddtNumber        String             @unique
  orderId          String?            @unique
  customerId       String
  status           DDTStatus          @default(DRAFT)
  issueDate        DateTime           @default(now())
  deliveryDate     DateTime?
  transportReason  String             @default("Vendita")
  transportedBy    String             @default("Mittente")
  goodsAppearance  String?
  numberOfPackages Int?
  weight           Decimal?           @db.Decimal(10, 2)
  signatureImage   String?
  deliveryNotes    String?
  createdById      String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  createdBy        User?              @relation(fields: [createdById], references: [id])
  customer         Customer           @relation(fields: [customerId], references: [id])
  order            Order?             @relation(fields: [orderId], references: [id])
  items            DeliveryNoteItem[]
  invoiceLinks     InvoiceDDTLink[]

  @@index([customerId])
  @@index([status])
  @@index([issueDate])
}

model DeliveryNoteItem {
  id             String       @id @default(cuid())
  deliveryNoteId String
  productId      String?
  quantity       Decimal      @db.Decimal(10, 3)
  unit           ProductUnit
  unitPrice      Decimal      @db.Decimal(10, 2)
  vatRate        Decimal      @default(4) @db.Decimal(4, 2)
  lineTotal      Decimal      @db.Decimal(10, 2)
  notes          String?
  sortOrder      Int          @default(0)
  productName    String?
  deliveryNote   DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  product        Product?     @relation(fields: [productId], references: [id])

  @@index([deliveryNoteId])
}

model Invoice {
  id            String           @id @default(cuid())
  invoiceNumber String           @unique
  customerId    String
  status        InvoiceStatus    @default(DRAFT)
  issueDate     DateTime         @default(now())
  dueDate       DateTime
  subtotal      Decimal          @db.Decimal(10, 2)
  vatAmount     Decimal          @db.Decimal(10, 2)
  total         Decimal          @db.Decimal(10, 2)
  paidAmount    Decimal          @default(0) @db.Decimal(10, 2)
  paymentMethod PaymentMethod?
  paymentTerms  String?
  notes         String?
  internalNotes String?
  pdfUrl        String?
  createdById   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  creditNotes   CreditNote[]
  createdBy     User?            @relation(fields: [createdById], references: [id])
  customer      Customer         @relation(fields: [customerId], references: [id])
  ddtLinks      InvoiceDDTLink[]
  items         InvoiceItem[]
  payments      Payment[]        @relation("InvoicePayments")

  @@index([customerId])
  @@index([status])
  @@index([issueDate])
  @@index([dueDate])
}

model InvoiceDDTLink {
  id             String       @id @default(cuid())
  invoiceId      String
  deliveryNoteId String
  deliveryNote   DeliveryNote @relation(fields: [deliveryNoteId], references: [id])
  invoice        Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, deliveryNoteId])
}

model InvoiceItem {
  id          String      @id @default(cuid())
  invoiceId   String
  productId   String?
  description String
  quantity    Decimal     @db.Decimal(10, 3)
  unit        ProductUnit
  unitPrice   Decimal     @db.Decimal(10, 2)
  costPrice   Decimal?    @db.Decimal(10, 2)
  vatRate     Decimal     @default(4) @db.Decimal(4, 2)
  lineTotal   Decimal     @db.Decimal(10, 2)
  sortOrder   Int         @default(0)
  supplierId  String?
  invoice     Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product?    @relation(fields: [productId], references: [id])
  supplier    Supplier?   @relation(fields: [supplierId], references: [id])

  @@index([invoiceId])
}

model CreditNote {
  id               String   @id @default(cuid())
  creditNoteNumber String   @unique
  invoiceId        String
  customerId       String
  issueDate        DateTime @default(now())
  amount           Decimal  @db.Decimal(10, 2)
  vatAmount        Decimal  @db.Decimal(10, 2)
  total            Decimal  @db.Decimal(10, 2)
  reason           String
  pdfUrl           String?
  createdAt        DateTime @default(now())
  customer         Customer @relation(fields: [customerId], references: [id])
  invoice          Invoice  @relation(fields: [invoiceId], references: [id])
}

model Payment {
  id                String           @id @default(cuid())
  direction         PaymentDirection
  status            PaymentStatus    @default(PENDING)
  amount            Decimal          @db.Decimal(10, 2)
  paymentDate       DateTime
  method            PaymentMethod
  reference         String?
  notes             String?
  customerId        String?
  supplierId        String?
  invoiceId         String?
  supplierInvoiceId String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  customer          Customer?        @relation("CustomerPayments", fields: [customerId], references: [id])
  invoice           Invoice?         @relation("InvoicePayments", fields: [invoiceId], references: [id])
  supplier          Supplier?        @relation("SupplierPayments", fields: [supplierId], references: [id])
  supplierInvoice   SupplierInvoice? @relation(fields: [supplierInvoiceId], references: [id])

  @@index([customerId])
  @@index([supplierId])
  @@index([direction])
  @@index([paymentDate])
}

model PurchaseOrder {
  id              String              @id @default(cuid())
  poNumber        String              @unique
  supplierId      String
  status          PurchaseOrderStatus @default(DRAFT)
  orderDate       DateTime            @default(now())
  expectedDate    DateTime?
  subtotal        Decimal             @default(0) @db.Decimal(10, 2)
  vatAmount       Decimal             @default(0) @db.Decimal(10, 2)
  total           Decimal             @default(0) @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  items           PurchaseOrderItem[]
  supplierInvoice SupplierInvoice?

  @@index([supplierId])
  @@index([status])
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  productId       String?
  quantity        Decimal       @db.Decimal(10, 3)
  unit            ProductUnit
  unitPrice       Decimal       @db.Decimal(10, 2)
  lineTotal       Decimal       @db.Decimal(10, 2)
  productName     String?
  product         Product?      @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([productId])
}

model SupplierInvoice {
  id                    String                @id @default(cuid())
  supplierInvoiceNumber String
  supplierId            String
  issueDate             DateTime
  dueDate               DateTime
  subtotal              Decimal               @db.Decimal(10, 2)
  vatAmount             Decimal               @db.Decimal(10, 2)
  total                 Decimal               @db.Decimal(10, 2)
  paidAmount            Decimal               @default(0) @db.Decimal(10, 2)
  isPaid                Boolean               @default(false)
  pdfUrl                String?
  notes                 String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  purchaseOrderId       String?               @unique
  payments              Payment[]
  purchaseOrder         PurchaseOrder?        @relation(fields: [purchaseOrderId], references: [id])
  supplier              Supplier              @relation(fields: [supplierId], references: [id])
  items                 SupplierInvoiceItem[]

  @@index([supplierId])
  @@index([dueDate])
  @@index([purchaseOrderId])
}

model SupplierInvoiceItem {
  id                String          @id @default(cuid())
  supplierInvoiceId String
  productId         String?
  description       String
  quantity          Decimal         @db.Decimal(10, 3)
  unit              ProductUnit
  unitPrice         Decimal         @db.Decimal(10, 2)
  vatRate           Decimal         @default(4) @db.Decimal(5, 2)
  lineTotal         Decimal         @db.Decimal(10, 2)
  sortOrder         Int             @default(0)
  product           Product?        @relation(fields: [productId], references: [id])
  supplierInvoice   SupplierInvoice @relation(fields: [supplierInvoiceId], references: [id], onDelete: Cascade)

  @@index([supplierInvoiceId])
}

model ShoppingList {
  id        String             @id @default(cuid())
  date      DateTime           @unique @db.Date
  status    ShoppingListStatus @default(DRAFT)
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  items     ShoppingListItem[]
}

model ShoppingListItem {
  id             String       @id @default(cuid())
  shoppingListId String
  productId      String?
  totalQuantity  Decimal      @db.Decimal(10, 3)
  availableStock Decimal      @default(0) @db.Decimal(10, 3)
  netQuantity    Decimal      @default(0) @db.Decimal(10, 3)
  unit           ProductUnit
  supplierId     String?
  supplierPrice  Decimal?     @db.Decimal(10, 2)
  isOrdered      Boolean      @default(false)
  isReceived     Boolean      @default(false)
  receivedQty    Decimal?     @db.Decimal(10, 3)
  notes          String?
  productName    String?
  product        Product?     @relation(fields: [productId], references: [id])
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  supplier       Supplier?    @relation(fields: [supplierId], references: [id])

  @@unique([shoppingListId, productId, productName])
  @@index([shoppingListId])
}

model WhatsAppMessage {
  id           String   @id @default(cuid())
  messageId    String   @unique
  from         String
  customerName String?
  body         String
  mediaUrl     String?
  timestamp    DateTime
  isProcessed  Boolean  @default(false)
  parsedData   Json?
  errorMessage String?
  createdAt    DateTime @default(now())
  orders       Order[]
}

model AudioTranscription {
  id            String   @id @default(cuid())
  fileName      String
  fileUrl       String
  fileSize      Int
  duration      Int?
  transcription String?
  parsedData    Json?
  status        String   @default("pending")
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]
}

model IncomingEmail {
  id           String   @id @default(cuid())
  messageId    String   @unique
  from         String
  subject      String
  body         String
  htmlBody     String?
  receivedAt   DateTime
  isProcessed  Boolean  @default(false)
  parsedData   Json?
  errorMessage String?
  createdAt    DateTime @default(now())
}

model StockMovement {
  id            String            @id @default(cuid())
  productId     String
  type          StockMovementType
  quantity      Decimal           @db.Decimal(10, 3)
  unit          ProductUnit       @default(KG)
  reason        String?
  referenceType String?
  referenceId   String?
  createdById   String?
  createdAt     DateTime          @default(now())
  createdBy     User?             @relation("StockMovements", fields: [createdById], references: [id])
  product       Product           @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String?
  entityId  String?
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model AppSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  category    String   @default("general")
  description String?
  updatedAt   DateTime @updatedAt
}

model CompanyInfo {
  id          String   @id @default(cuid())
  companyName String
  vatNumber   String
  fiscalCode  String
  address     String
  city        String
  province    String
  postalCode  String
  country     String   @default("IT")
  phone       String?
  email       String?
  pecEmail    String?
  sdiCode     String?
  logoUrl     String?
  bankName    String?
  bankIban    String?
  bankBic     String?
  updatedAt   DateTime @updatedAt
}

model NumberSequence {
  id         String  @id @default(cuid())
  type       String
  year       Int
  lastNumber Int     @default(0)
  prefix     String?

  @@unique([type, year])
}

enum Role {
  ADMIN
  OPERATOR
  VIEWER
  CUSTOMER
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum ProductUnit {
  KG
  G
  PEZZI
  CASSETTA
  MAZZO
  GRAPPOLO
  VASETTO
  SACCHETTO
}

enum ProductCategoryType {
  FRUTTA
  VERDURA
  ORTAGGI
  ERBE_AROMATICHE
  SPEZIE
  FRUTTA_ESOTICA
  FRUTTA_SECCA
}

enum CustomerType {
  RISTORANTE
  SUPERMERCATO
  BAR
  HOTEL
  MENSA
  GASTRONOMIA
  ALTRO
}

enum PaymentMethod {
  CONTANTI
  BONIFICO
  ASSEGNO
  RIBA
  CARTA
}

enum OrderStatus {
  RECEIVED
  CONFIRMED
  IN_PREPARATION
  DELIVERED
  INVOICED
  CANCELLED
}

enum OrderChannel {
  WHATSAPP
  EMAIL
  AUDIO
  MANUAL
  WEB
}

enum DDTStatus {
  DRAFT
  ISSUED
  DELIVERED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentDirection {
  INCOMING
  OUTGOING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  RECEIVED
  CANCELLED
}

enum ShoppingListStatus {
  DRAFT
  FINALIZED
  ORDERED
  RECEIVED
}

enum StockMovementType {
  CARICO
  SCARICO
  RETTIFICA_POS
  RETTIFICA_NEG
  SCARTO
}
